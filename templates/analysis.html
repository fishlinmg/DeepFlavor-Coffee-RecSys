{% extends "base.html" %}

{% block title %}数据分析 - DeepFlavor Coffee{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">
        <i class="fas fa-chart-bar me-2"></i>
        精品咖啡数据分析
    </h2>

    <div class="row">
        <!-- 产地平均评分排名 -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-globe me-2"></i>
                        各产地咖啡平均评分排名
                    </h5>
                    <div id="country-chart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- 产地统计 -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>
                        产地统计
                    </h5>
                    <div id="country-stats">
                        {% for country, score, count in zip(country_data.countries, country_data.scores, country_data.counts) %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <strong>{{ country }}</strong>
                                <span>{{ score }}</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {{ (score / 10 * 100) }}%"></div>
                            </div>
                            <small class="text-muted">{{ count }} 款咖啡</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 处理法分布 -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie me-2"></i>
                        处理法分布
                    </h5>
                    <div id="processing-chart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 产地评分柱状图
    const countryChart = echarts.init(document.getElementById('country-chart'));
    const countryOption = {
        title: {
            text: 'Top 15 产地平均评分',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            max: 10,
            axisLabel: {
                formatter: '{value}'
            }
        },
        yAxis: {
            type: 'category',
            data: {{ country_data.countries|tojson }},
            axisLabel: {
                interval: 0,
                rotate: 30
            }
        },
        series: [{
            type: 'bar',
            data: {{ country_data.scores|tojson }},
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                    { offset: 0, color: '#6F4E37' },
                    { offset: 1, color: '#A0826D' }
                ])
            },
            label: {
                show: true,
                position: 'right',
                formatter: '{c}'
            }
        }]
    };
    countryChart.setOption(countryOption);

    // 处理法分布饼图
    const processingChart = echarts.init(document.getElementById('processing-chart'));
    const processingOption = {
        title: {
            text: '咖啡处理法分布',
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [{
            type: 'pie',
            radius: '50%',
            data: [
                {% for method, count in zip(processing_data.methods, processing_data.counts) %}
                { value: {{ count }}, name: '{{ method }}' }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            }
        }]
    };
    processingChart.setOption(processingOption);

    // 响应式调整
    window.addEventListener('resize', function() {
        countryChart.resize();
        processingChart.resize();
    });
</script>
{% endblock %}
